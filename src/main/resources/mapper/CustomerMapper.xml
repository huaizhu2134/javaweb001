<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.oracle01.mapper.CustomerMapper">

    <resultMap id="BaseResultMap" type="org.example.oracle01.model.Customer">
        <id column="CUSTOMER_ID" property="customerId" jdbcType="NUMERIC"/>
        <result column="USERNAME" property="username" jdbcType="VARCHAR"/>
        <result column="PASSWORD" property="password" jdbcType="VARCHAR"/>
        <result column="NICKNAME" property="nickname" jdbcType="VARCHAR"/>
        <result column="PHONE" property="phone" jdbcType="VARCHAR"/>
        <result column="EMAIL" property="email" jdbcType="VARCHAR"/>
        <result column="GENDER" property="gender" jdbcType="CHAR"/>
        <result column="AGE" property="age" jdbcType="NUMERIC"/>
        <result column="AVATAR_URL" property="avatarUrl" jdbcType="VARCHAR"/>
        <result column="MEMBER_LEVEL" property="memberLevel" jdbcType="VARCHAR"/>
        <result column="TOTAL_CONSUME" property="totalConsume" jdbcType="DECIMAL"/>
        <result column="ORDER_COUNT" property="orderCount" jdbcType="NUMERIC"/>
        <result column="BALANCE" property="balance" jdbcType="DECIMAL"/>
        <result column="STATUS" property="status" jdbcType="VARCHAR"/>
        <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="LAST_LOGIN_TIME" property="lastLoginTime" jdbcType="TIMESTAMP"/>
        <result column="IS_DELETED" property="isDeleted" jdbcType="CHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        CUSTOMER_ID, USERNAME, PASSWORD, NICKNAME, PHONE, EMAIL, GENDER, 
        AGE, AVATAR_URL, MEMBER_LEVEL, TOTAL_CONSUME, ORDER_COUNT, 
        BALANCE, STATUS, CREATE_TIME, UPDATE_TIME, LAST_LOGIN_TIME, IS_DELETED
    </sql>

    <select id="selectCustomerList" parameterType="map" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_CUSTOMER
        WHERE IS_DELETED = 'N'
        <if test="params.username != null and params.username != ''">
            AND USERNAME LIKE CONCAT('%', #{params.username}, '%')
        </if>
        <if test="params.status != null and params.status != ''">
            AND STATUS = #{params.status}
        </if>
        ORDER BY CREATE_TIME DESC
        <if test="params.page != null and params.size != null">
            OFFSET #{params.page} ROWS
            FETCH NEXT #{params.size} ROWS ONLY
        </if>
    </select>

    <select id="selectCustomerById" parameterType="long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_CUSTOMER
        WHERE CUSTOMER_ID = #{id} AND IS_DELETED = 'N'
    </select>

    <insert id="insertCustomer" parameterType="org.example.oracle01.model.Customer">
        INSERT INTO TB_CUSTOMER (
            CUSTOMER_ID, USERNAME, PASSWORD, NICKNAME, PHONE, EMAIL, 
            GENDER, AGE, AVATAR_URL, MEMBER_LEVEL, TOTAL_CONSUME, 
            ORDER_COUNT, BALANCE, STATUS, CREATE_TIME, UPDATE_TIME, 
            LAST_LOGIN_TIME, IS_DELETED
        ) VALUES (
            SEQ_CUSTOMER_ID.NEXTVAL, #{username}, #{password}, #{nickname}, 
            #{phone}, #{email}, #{gender}, #{age}, #{avatarUrl}, 
            #{memberLevel}, #{totalConsume}, #{orderCount}, #{balance}, 
            #{status}, SYSDATE, SYSDATE, #{lastLoginTime}, 'N'
        )
    </insert>

    <update id="updateCustomer" parameterType="org.example.oracle01.model.Customer">
        UPDATE TB_CUSTOMER
        <set>
            <if test="username != null">USERNAME = #{username},</if>
            <if test="password != null">PASSWORD = #{password},</if>
            <if test="nickname != null">NICKNAME = #{nickname},</if>
            <if test="phone != null">PHONE = #{phone},</if>
            <if test="email != null">EMAIL = #{email},</if>
            <if test="gender != null">GENDER = #{gender},</if>
            <if test="age != null">AGE = #{age},</if>
            <if test="avatarUrl != null">AVATAR_URL = #{avatarUrl},</if>
            <if test="memberLevel != null">MEMBER_LEVEL = #{memberLevel},</if>
            <if test="totalConsume != null">TOTAL_CONSUME = #{totalConsume},</if>
            <if test="orderCount != null">ORDER_COUNT = #{orderCount},</if>
            <if test="balance != null">BALANCE = #{balance},</if>
            <if test="status != null">STATUS = #{status},</if>
            <if test="lastLoginTime != null">LAST_LOGIN_TIME = #{lastLoginTime},</if>
            UPDATE_TIME = SYSDATE,
        </set>
        WHERE CUSTOMER_ID = #{customerId} AND IS_DELETED = 'N'
    </update>

    <update id="deleteCustomer" parameterType="long">
        UPDATE TB_CUSTOMER
        SET IS_DELETED = 'Y', UPDATE_TIME = SYSDATE
        WHERE CUSTOMER_ID = #{id}
    </update>

    <select id="countCustomer" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TB_CUSTOMER
        WHERE IS_DELETED = 'N'
        <if test="params.username != null and params.username != ''">
            AND USERNAME LIKE CONCAT('%', #{params.username}, '%')
        </if>
        <if test="params.status != null and params.status != ''">
            AND STATUS = #{params.status}
        </if>
    </select>

    <!-- 充值 - 更新余额 -->
    <update id="rechargeBalance">
        UPDATE TB_CUSTOMER
        SET BALANCE = BALANCE + #{amount},
            UPDATE_TIME = SYSDATE
        WHERE CUSTOMER_ID = #{customerId} AND IS_DELETED = 'N'
    </update>
</mapper>