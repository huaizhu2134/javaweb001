<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.oracle01.mapper.OrderMapper">

    <resultMap id="BaseResultMap" type="map">
        <id column="ORDER_ID" property="orderId" jdbcType="BIGINT"/>
        <result column="ORDER_NO" property="orderNo" jdbcType="VARCHAR"/>
        <result column="CUSTOMER_ID" property="customerId" jdbcType="INTEGER"/>
        <result column="STAFF_ID" property="staffId" jdbcType="INTEGER"/>
        <result column="GAME_TYPE" property="gameType" jdbcType="VARCHAR"/>
        <result column="SERVICE_HOURS" property="serviceHours" jdbcType="INTEGER"/>
        <result column="UNIT_PRICE" property="unitPrice" jdbcType="DECIMAL"/>
        <result column="TOTAL_AMOUNT" property="totalAmount" jdbcType="DECIMAL"/>
        <result column="PLATFORM_COMMISSION" property="platformCommission" jdbcType="DECIMAL"/>
        <result column="STAFF_INCOME" property="staffIncome" jdbcType="DECIMAL"/>
        <result column="ORDER_STATUS" property="orderStatus" jdbcType="VARCHAR"/>
        <result column="PAY_TIME" property="payTime" jdbcType="TIMESTAMP"/>
        <result column="START_TIME" property="startTime" jdbcType="TIMESTAMP"/>
        <result column="END_TIME" property="endTime" jdbcType="TIMESTAMP"/>
        <result column="CUSTOMER_COMMENT" property="customerComment" jdbcType="VARCHAR"/>
        <result column="STAFF_COMMENT" property="staffComment" jdbcType="VARCHAR"/>
        <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="IS_DELETED" property="isDeleted" jdbcType="CHAR"/>
        <result column="CUSTOMER_NAME" property="customerName" jdbcType="VARCHAR"/>
        <result column="STAFF_NAME" property="staffName" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        ORDER_ID, ORDER_NO, CUSTOMER_ID, STAFF_ID, GAME_TYPE, SERVICE_HOURS, 
        UNIT_PRICE, TOTAL_AMOUNT, PLATFORM_COMMISSION, STAFF_INCOME, ORDER_STATUS, 
        PAY_TIME, START_TIME, END_TIME, CUSTOMER_COMMENT, STAFF_COMMENT, 
        CREATE_TIME, UPDATE_TIME, IS_DELETED
    </sql>

    <select id="selectOrderList" parameterType="map" resultMap="BaseResultMap">
        SELECT 
            o.ORDER_ID, o.ORDER_NO, o.CUSTOMER_ID, o.STAFF_ID, o.GAME_TYPE, o.SERVICE_HOURS, 
            o.UNIT_PRICE, o.TOTAL_AMOUNT, o.PLATFORM_COMMISSION, o.STAFF_INCOME, o.ORDER_STATUS, 
            o.PAY_TIME, o.START_TIME, o.END_TIME, o.CUSTOMER_COMMENT, o.STAFF_COMMENT, 
            o.CREATE_TIME, o.UPDATE_TIME, o.IS_DELETED,
            c.NICKNAME AS CUSTOMER_NAME,
            s.STAFF_NAME
        FROM TB_ORDER o
        LEFT JOIN TB_CUSTOMER c ON o.CUSTOMER_ID = c.CUSTOMER_ID
        LEFT JOIN TB_STAFF s ON o.STAFF_ID = s.STAFF_ID
        WHERE o.IS_DELETED = 'N'
        <if test="params.orderNo != null and params.orderNo != ''">
            AND o.ORDER_NO LIKE CONCAT('%', #{params.orderNo}, '%')
        </if>
        <if test="params.customerId != null">
            AND o.CUSTOMER_ID = #{params.customerId}
        </if>
        <if test="params.staffId != null">
            AND o.STAFF_ID = #{params.staffId}
        </if>
        <if test="params.status != null and params.status != ''">
            AND o.ORDER_STATUS = #{params.status}
        </if>
        <if test="params.customerName != null and params.customerName != ''">
            AND c.NICKNAME LIKE CONCAT('%', #{params.customerName}, '%')
        </if>
        <if test="params.staffName != null and params.staffName != ''">
            AND s.STAFF_NAME LIKE CONCAT('%', #{params.staffName}, '%')
        </if>
        <if test="params.gameType != null and params.gameType != ''">
            AND o.GAME_TYPE = #{params.gameType}
        </if>
        <if test="params.startTime != null and params.startTime != ''">
            AND DATE(o.CREATE_TIME) >= DATE(#{params.startTime})
        </if>
        <if test="params.endTime != null and params.endTime != ''">
            AND DATE(o.CREATE_TIME) &lt;= DATE(#{params.endTime})
        </if>
        ORDER BY o.CREATE_TIME DESC
        <if test="params.page != null and params.size != null">
            LIMIT #{params.size} OFFSET #{params.page}
        </if>
    </select>

    <select id="selectOrderById" parameterType="long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_ORDER
        WHERE ORDER_ID = #{id} AND IS_DELETED = 'N'
    </select>

    <insert id="insertOrder" parameterType="org.example.oracle01.model.Order">
        INSERT INTO TB_ORDER (
            ORDER_ID, ORDER_NO, CUSTOMER_ID, STAFF_ID, GAME_TYPE, 
            SERVICE_HOURS, UNIT_PRICE, TOTAL_AMOUNT, PLATFORM_COMMISSION, 
            STAFF_INCOME, ORDER_STATUS, PAY_TIME, START_TIME, END_TIME, 
            CUSTOMER_COMMENT, STAFF_COMMENT, CREATE_TIME, UPDATE_TIME, IS_DELETED
        ) VALUES (
            #{orderId}, #{orderNo}, #{customerId}, #{staffId}, 
            #{gameType}, #{serviceHours}, #{unitPrice}, #{totalAmount}, 
            #{platformCommission}, #{staffIncome}, #{orderStatus}, 
            #{payTime}, #{startTime}, #{endTime}, #{customerComment}, 
            #{staffComment}, NOW(), NOW(), 'N'
        )
    </insert>

    <update id="updateOrder" parameterType="org.example.oracle01.model.Order">
        UPDATE TB_ORDER
        <set>
            <if test="orderNo != null">ORDER_NO = #{orderNo},</if>
            <if test="customerId != null">CUSTOMER_ID = #{customerId},</if>
            <if test="staffId != null">STAFF_ID = #{staffId},</if>
            <if test="gameType != null">GAME_TYPE = #{gameType},</if>
            <if test="serviceHours != null">SERVICE_HOURS = #{serviceHours},</if>
            <if test="unitPrice != null">UNIT_PRICE = #{unitPrice},</if>
            <if test="totalAmount != null">TOTAL_AMOUNT = #{totalAmount},</if>
            <if test="platformCommission != null">PLATFORM_COMMISSION = #{platformCommission},</if>
            <if test="staffIncome != null">STAFF_INCOME = #{staffIncome},</if>
            <if test="orderStatus != null">ORDER_STATUS = #{orderStatus},</if>
            <if test="payTime != null">PAY_TIME = #{payTime},</if>
            <if test="startTime != null">START_TIME = #{startTime},</if>
            <if test="endTime != null">END_TIME = #{endTime},</if>
            <if test="customerComment != null">CUSTOMER_COMMENT = #{customerComment},</if>
            <if test="staffComment != null">STAFF_COMMENT = #{staffComment},</if>
            <if test="updateTime != null">UPDATE_TIME = #{updateTime},</if>
        </set>
        WHERE ORDER_ID = #{orderId} AND IS_DELETED = 'N'
    </update>

    <update id="deleteOrder" parameterType="long">
        UPDATE TB_ORDER
        SET IS_DELETED = 'Y', UPDATE_TIME = NOW()
        WHERE ORDER_ID = #{id}
    </update>

    <select id="countOrder" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TB_ORDER
        LEFT JOIN TB_CUSTOMER c ON TB_ORDER.CUSTOMER_ID = c.CUSTOMER_ID
        LEFT JOIN TB_STAFF s ON TB_ORDER.STAFF_ID = s.STAFF_ID
        WHERE TB_ORDER.IS_DELETED = 'N'
        <if test="params.orderNo != null and params.orderNo != ''">
            AND TB_ORDER.ORDER_NO LIKE CONCAT('%', #{params.orderNo}, '%')
        </if>
        <if test="params.customerName != null and params.customerName != ''">
            AND c.NICKNAME LIKE CONCAT('%', #{params.customerName}, '%')
        </if>
        <if test="params.staffName != null and params.staffName != ''">
            AND s.STAFF_NAME LIKE CONCAT('%', #{params.staffName}, '%')
        </if>
        <if test="params.status != null and params.status != ''">
            AND TB_ORDER.ORDER_STATUS = #{params.status}
        </if>
        <if test="params.gameType != null and params.gameType != ''">
            AND TB_ORDER.GAME_TYPE = #{params.gameType}
        </if>
        <if test="params.startTime != null and params.startTime != ''">
            AND DATE(TB_ORDER.CREATE_TIME) >= DATE(#{params.startTime})
        </if>
        <if test="params.endTime != null and params.endTime != ''">
            AND DATE(TB_ORDER.CREATE_TIME) &lt;= DATE(#{params.endTime})
        </if>
    </select>

    <update id="updateOrderStatus" parameterType="map">
        UPDATE TB_ORDER
        SET ORDER_STATUS = #{status}, UPDATE_TIME = NOW()
        WHERE ORDER_ID = #{id}
    </update>
</mapper>